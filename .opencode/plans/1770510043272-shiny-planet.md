# CodeQL Permission Fix Plan

## Goal
Fix the GitHub CodeQL warning:
"This run of the CodeQL Action does not have permission to access the CodeQL Action API endpoints... ensure the workflow has at least `security-events: read`."

User choices captured:
- Add a repo-managed CodeQL workflow file.
- Use `security-events: write` (recommended) instead of read-only.

## Findings From Exploration
- There is currently **no CodeQL workflow** in this branch.
- Existing workflow files:
  - `.github/workflows/ci.yml`
  - `.github/workflows/release.yml`
- Existing convention in this repo: explicit **job-level** `permissions` blocks (least privilege), not workflow-level permissions.
- No current use of `security-events` in existing workflows.

## Recommended Implementation

### 1) Add new workflow
Create:
- `.github/workflows/codeql.yml`

### 2) Configure triggers
Use:
- `push` on `main`
- `pull_request` targeting `main`
- `workflow_dispatch`

This ensures CodeQL runs for regular pushes, PR validation, and manual reruns.

### 3) Add job-level least-privilege permissions
In the CodeQL job, set:
- `contents: read`
- `security-events: write`
- `actions: read`

Rationale:
- `security-events: write` is standard for CodeQL analysis result upload (SARIF/code scanning).
- `actions: read` helps avoid API endpoint access warnings in some integrations.
- Keeps scope narrow and matches repo pattern of explicit job-level permissions.

### 4) Implement standard CodeQL job steps (Java)
Use canonical GitHub CodeQL actions:
1. `actions/checkout@v4`
2. `github/codeql-action/init@v3` with language matrix `java-kotlin`
3. `github/codeql-action/autobuild@v3`
4. `github/codeql-action/analyze@v3`

Notes:
- `java-kotlin` is the expected CodeQL language identifier for Java projects.
- Keep this workflow isolated from `ci.yml` and `release.yml`.

## Critical Files To Modify
- `.github/workflows/codeql.yml` (new)

## Verification Plan

### A) Workflow correctness checks
- Validate YAML and permissions block placement by reviewing committed file.
- Confirm no changes are needed in:
  - `.github/workflows/ci.yml`
  - `.github/workflows/release.yml`

### B) Runtime validation on GitHub
After pushing branch:
1. Trigger workflow manually:
   - `gh workflow run codeql.yml --ref <branch>`
2. Get latest run:
   - `gh run list --workflow codeql.yml --limit 1`
3. Inspect logs:
   - `gh run view <run-id> --log`
4. Confirm warning is gone:
   - No message containing
     `does not have permission to access the CodeQL Action API endpoints`
5. Confirm analysis uploaded successfully:
   - `gh run view <run-id>` shows success for analyze step
   - Optionally check code scanning analyses:
     - `gh api repos/<owner>/<repo>/code-scanning/analyses`

### C) PR behavior sanity check
- Open/update PR from branch and verify CodeQL check runs.
- For fork PRs, expect GitHub token restrictions to still apply by policy; this plan addresses the missing permissions in repo-managed workflow context.
