# Documentation Update Plan - Heap-Based Architecture

## Context
Comprehensive codebase exploration revealed MAJOR inconsistencies between documentation and actual implementation:
- **Actual:** 100% heap-based storage, ByteBuddy table generation
- **Docs claim:** FFM/SIMD storage, 7 layers (Factory/Emitter), TypeCodes enum, repository generation
- **Test coverage:** Strong for parsing (75%), weak for execution (0% for many components)

---

## Phase 1: ARCHITECTURE.md (COMPLETE REWRITE)

### Delete Entire File
- All content describes FFM/SIMD architecture that doesn't exist
- Delete and start from scratch

### Create New ARCHITECTURE.md with These Sections:

#### Section 1: Overview
**Content:**
- Memris: heap-based in-memory storage engine for Java 21
- Key principles: O(1) hot paths, zero reflection, compile-time generation
- ByteBuddy generates TABLE classes (not repository classes)
- HeapRuntimeKernel executes queries (not RepositoryRuntime)
- TypeCodes: final class with static constants (not enum)

#### Section 2: High-Level Architecture Diagram
**Use simplified PlantUML:**
```
[Entity] -> [TableGenerator] -> [GeneratedTable]
[QueryMethodLexer] -> [QueryPlanner] -> [CompiledQuery]
[HeapRuntimeKernel] -> [GeneratedTable]
```

#### Section 3: Package Structure
**Accurate mapping:**
```
io.memris.kernel              - Selection vectors, predicates, plan nodes
io.memris.storage             - Core storage interfaces (Table, Selection)
io.memris.storage.heap        - Heap-based table implementation (TableGenerator, PageColumn*)
io.memris.spring              - Custom annotations, TypeCodes, BuiltInResolver
io.memris.spring.plan         - Query parsing (Lexer, Planner, Compiler, OpCode)
io.memris.spring.runtime      - HeapRuntimeKernel, EntityMaterializer, EntityExtractor
io.memris.index               - HashIndex, RangeIndex, StringIdIndex, LongIdIndex
```

#### Section 4: Key Components
**Reference actual files:**
- `TableGenerator.java:31` - Generates table classes via ByteBuddy
- `HeapRuntimeKernel.java:9` - Zero-reflection query execution
- `TypeCodes.java:16` - Static type code constants
- `BuiltInResolver.java:25` - Built-in operation resolution
- `QueryMethodLexer.java` - Tokenizes method names
- `QueryPlanner.java` - Creates LogicalQuery
- `GeneratedTable.java:15` - Low-level table interface

#### Section 5: Build-Time vs Runtime
**Build-time (once):**
```
Entity annotations -> TableMetadata
-> TableGenerator.generate() -> GeneratedTable class
```

**Runtime (hot path):**
```
HeapRuntimeKernel.executeCondition()
-> GeneratedTable.scanEqualsLong()
-> return int[] rowIndices
```

#### Section 6: Custom Annotations
**Document actual annotations:**
- `io.memris.spring.Entity` - Entity marker
- `io.memris.spring.Index` - Index annotation
- `io.memris.spring.GeneratedValue` - Auto ID generation
- `io.memris.spring.GenerationType` - ID generation types
- `io.memris.spring.OneToOne` - Relationships

**NOTE:** These are NOT Jakarta/JPA annotations

---

## Phase 2: QUERY.md (UPDATE EXISTING)

### Delete/Update Sections:
- **Line 9:** Delete reference to `QueryMethodParser` - doesn't exist
- **Lines 88-95:** Update method naming patterns to match actual implementation

### Add Sections:
#### Section: Actual Query Parsing Flow
```
QueryMethodLexer.tokenize() -> List<QueryMethodToken>
-> QueryPlanner.plan() -> LogicalQuery
-> (compile) -> CompiledQuery
```

**Reference files:**
- `QueryMethodLexer.java`
- `QueryPlanner.java`
- `CompiledQuery.java`

#### Section: BuiltInResolver
**Document BuiltInResolver:**
- `BuiltInResolver.java:57` - resolveBuiltInOpCode()
- Handles built-in methods (findById, save, delete, etc.)
- Deterministic tie-breaking for method signature matching

---

## Phase 3: DEVELOPMENT.md (MAJOR UPDATE)

### Delete Sections:
- **Lines 25-32:** Delete all benchmark commands (FFM/SIMD don't exist)
- **Lines 36-39:** Delete `jdk.incubator.vector` and FFM references
- **Lines 97-110:** Delete Vector API usage examples

### Update Sections:
#### Java Runtime Requirements (Line 34-39)
**Replace with:**
```markdown
- **Java Version**: 21 (required)
- **Preview Features**: `--enable-preview`
- **Native Access**: `--enable-native-access=ALL-UNNAMED` (for FFM, but currently not used)
- **Heap-based storage** (no FFM/MemorySegment in current implementation)
```

#### Key Implementation Files (Lines 292-299)
**Replace with:**
| File | Purpose |
|------|---------|
| `TableGenerator.java` | ByteBuddy table class generation |
| `HeapRuntimeKernel.java` | Zero-reflection query execution |
| `QueryMethodLexer.java` | Query method tokenization |
| `QueryPlanner.java` | Logical query creation |
| `GeneratedTable.java` | Low-level table interface |
| `TypeCodes.java` | Type code constants |

#### Add New Section: Storage Implementation
**Content:**
- 100% heap-based storage (PageColumnInt, PageColumnLong, PageColumnString)
- No FFM, MemorySegment, or Vector API
- ByteBuddy generates table classes in `io.memris.storage.generated`
- Reference: `TableGenerator.java:31`, `PageColumnInt.java`, `PageColumnLong.java`

---

## Phase 4: SPRING_DATA.md (UPDATE EXISTING)

### Delete/Update Sections:
- **Lines 4-6:** Delete "Jakarta/JPA annotation support" - uses custom annotations
- **Line 16:** Delete `CrudRepository`/`PagingAndSortingRepository` reference - not implemented
- **Lines 49-56:** Update annotation references to custom ones

### Update Sections:
#### Current Implementation Status (Lines 18-41)
**Correct annotation references:**
- Entity detection via `io.memris.spring.Entity`
- ID generation via `io.memris.spring.GeneratedValue`
- Indexes via `io.memris.spring.Index`
- Relationships via `io.memris.spring.OneToOne` (custom)

#### Remove FFM/SIMD References:
- **Line 270:** Delete "SIMD vector scans with Panama Vector API"
- **Line 329:** Delete "SIMD String Matching" section
- **Line 31:** Delete SIMD references from roadmap

---

## Phase 5: CLAUDE.md (UPDATE PACKAGE STRUCTURE)

### Delete Lines 28-33:
```markdown
| **Compiler** | LogicalQuery → CompiledQuery (QueryCompiler) |
| **Metadata** | Entity → Structure (EntityMetadata) |
| **Runtime** | Query Execution (RepositoryRuntime) |
| **Emitter** | ByteBuddy Generation (RepositoryEmitter) |
| **Factory** | Orchestration & CRUD (MemrisRepositoryFactory) |
```

### Replace with Correct Package Structure:
```
| Package | Purpose |
|---------|---------|
| `io.memris.kernel` | Selection vectors, predicates, plan nodes, executor, hash join |
| `io.memris.storage` | Core storage interfaces (Table, Selection) |
| `io.memris.storage.heap` | Heap-based table implementation (TableGenerator, PageColumn*, AbstractTable) |
| `io.memris.spring` | Custom annotations, TypeCodes, IdGenerator, BuiltInResolver |
| `io.memris.spring.plan` | Query parsing (QueryMethodLexer, QueryPlanner, QueryCompiler, OpCode) |
| `io.memris.spring.runtime` | HeapRuntimeKernel, EntityMaterializer, EntityExtractor |
| `io.memris.index` | HashIndex, RangeIndex, StringIdIndex, LongIdIndex |
```

### Update Important Files (Lines 40-50):
```
| File | Purpose |
|------|---------|
| `TableGenerator.java` | ByteBuddy table class generation |
| `HeapRuntimeKernel.java` | Zero-reflection query execution |
| `QueryMethodLexer.java` | Tokenizes query method names |
| `QueryPlanner.java` | Creates LogicalQuery from tokens |
| `CompiledQuery.java` | Compiled query with resolved column indices |
| `BuiltInResolver.java` | Built-in operation keyword resolution |
| `TypeCodes.java` | Type code constants (final class, not enum) |
```

### Delete Line 64:
"Join Table Implementation" section - references FFM and doesn't match actual heap-based implementation

### Delete Line 77:
"For complete operator reference, see **[docs/REFERENCE.md](docs/REFERENCE.md)**" - REFERENCE.md doesn't exist, it's QUERY.md

---

## Verification Checklist

After implementing changes:

### ARCHITECTURE.md:
- [ ] No references to FFM, MemorySegment, Vector API, SIMD
- [ ] TypeCodes documented as final class with static constants
- [ ] HeapRuntimeKernel documented (not RepositoryRuntime)
- [ ] ByteBuddy generates TABLE classes (not repository classes)
- [ ] Custom annotations documented (not Jakarta/JPA)
- [ ] Package structure matches actual `io.memris.*` packages

### QUERY.md:
- [ ] No references to QueryMethodParser (use QueryMethodLexer/QueryPlanner)
- [ ] BuiltInResolver documented
- [ ] Actual token flow documented

### DEVELOPMENT.md:
- [ ] No FFM/SIMD benchmark commands
- [ ] Java 21 requirements accurate (no jdk.incubator.vector needed)
- [ ] Storage implementation documented as heap-based
- [ ] Key implementation files reference actual files

### SPRING_DATA.md:
- [ ] Custom annotations documented (not Jakarta/JPA)
- [ ] No SIMD references in roadmap
- [ ] Implementation status accurate

### CLAUDE.md:
- [ ] Package structure matches actual packages
- [ ] Important files reference actual files
- [ ] No Factory/Emitter layer references
- [ ] Reference to QUERY.md (not REFERENCE.md)

---

## Execution Order

1. **ARCHITECTURE.md** - Complete rewrite (delete and recreate)
2. **QUERY.md** - Update existing file
3. **DEVELOPMENT.md** - Major updates
4. **SPRING_DATA.md** - Updates
5. **CLAUDE.md** - Package structure updates

Each document should reference actual file paths and include line numbers where possible for accuracy.
