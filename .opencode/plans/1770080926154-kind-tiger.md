# Plan: Fix or Suppress 900+ PMD/CPD Issues

## Context
- **Current State:** 919 PMD violations + 73 CPD duplications reported
- **Build Status:** All 669 tests pass (violations are warnings, not errors)
- **Goal:** Reduce noise while accepting intentional design choices

## Violation Analysis Summary

### Quick Fixes (Low Effort, High Value)
1. **@FunctionalInterface annotations** - 2 files, 1 line each
   - `AuditProvider.java` - single method `Object currentUser()`
   - `IdGenerator.java` - single method `T generate()`

### Intentional Design Choices (Accept + Document)
1. **God Classes** (MetadataExtractor, BuiltInResolver, JpqlQueryParser)
   - Cognitive complexity: 38, 24-23, 45 respectively
   - **Rationale:** Build-time components, not hot-path code. Splitting would hurt maintainability

2. **LooseCoupling violations** (HashIndex, RangeIndex, StringPrefixIndex)
   - Using concrete types: ConcurrentHashMap, ConcurrentSkipListMap
   - **Rationale:** Lock-free performance optimization for private fields

3. **CPD Duplication** (MethodHandleImplementation, BytecodeTableGenerator)
   - 73 duplications between two alternative implementation strategies
   - **Rationale:** Strategy pattern - each implementation is independent and specialized

4. **Dangling Javadoc** (CompiledQuery.java)
   - 10+ flagged Javadocs on record components
   - **Rationale:** Valid record component Javadoc (PMD ruleset may be outdated)

### Optional Style Fixes
1. **Missing control braces** (BuiltInResolver.java:111-114)
   - Single-statement if blocks
   - **Recommendation:** Suppress for lock-free code consistency

2. **RowIdBitSet violations**
   - AssignmentInOperand (line 102, 124)
   - SimplifyBooleanReturns (line 86) - likely false positive
   - AvoidLiteralsInIfCondition (multiple)
   - **Recommendation:** Minor tweaks + suppress

## Implementation Plan

### Phase 1: Quick Fixes (5 minutes)

#### 1.1 Add @FunctionalInterface annotations
**Files:**
- `memris-core/src/main/java/io/memris/core/AuditProvider.java`
- `memris-core/src/main/java/io/memris/core/IdGenerator.java`

**Action:** Add `@FunctionalInterface` annotation before interface declaration

**Verification:**
```bash
mvn clean compile
mvn test -Dtest=AuditProviderTest,IdGeneratorTest
```

### Phase 2: Update PMD Rules (15 minutes)

#### 2.1 Update `pmd-rules.xml`
Add explicit excludes with documentation comments:

```xml
<!-- Code Style -->
<rule ref="category/java/codestyle.xml">
    <!-- ... existing excludes ... -->
    <exclude name="ImplicitFunctionalInterface" /><!-- Not needed after Phase 1 -->
    <exclude name="ControlStatementBraces" /><!-- Concise style for lock-free code -->
</rule>

<!-- Design -->
<rule ref="category/java/design.xml">
    <!-- ... existing excludes ... -->
    <exclude name="GodClass" /><!-- Build-time components justified -->
    <exclude name="CognitiveComplexity" /><!-- Complex query parsing and method resolution necessary -->
</rule>

<!-- Documentation -->
<rule ref="category/java/documentation.xml">
    <!-- ... existing excludes ... -->
    <exclude name="DanglingJavadoc" /><!-- Valid record component Javadoc in CompiledQuery -->
</rule>

<!-- Error Prone -->
<rule ref="category/java/errorprone.xml">
    <!-- ... existing excludes ... -->
    <exclude name="AssignmentInOperand" /><!-- Intentional for performance-critical paths -->
    <exclude name="SimplifyBooleanReturns" /><!-- False positives on boolean expressions -->
    <exclude name="AvoidLiteralsInIfCondition" /><!-- Literals (0L, 1, etc.) are intentional -->
</rule>
```

#### 2.2 Fix duplicate UnnecessaryImport reference
**File:** `pmd-rules.xml`
- Remove line 36 (duplicate UnnecessaryImport reference)
- Keep line 11-13 (within codestyle.xml category)

#### 2.3 Create `pmd-excluded.xml` for specific file suppressions
**Purpose:** Document intentional violations with file-specific context

```xml
<?xml version="1.0" encoding="UTF-8"?>
<ruleset name="Memris PMD Exclusions"
         xmlns="http://pmd.sourceforge.net/ruleset/2.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://pmd.sourceforge.net/ruleset/2.0.0 https://pmd.sourceforge.io/ruleset_2_0_0.xsd">

    <description>
        PMD exclusions for Memris project - intentional design choices.

        These violations are accepted as they reflect the project's focus on:
        - Lock-free performance optimization
        - Zero-reflection hot paths
        - Build-time vs runtime separation
        - Alternative implementation strategies (MethodHandle vs Bytecode)
    </description>

    <!-- God Classes: Build-time components justified -->
    <exclude-pattern>**/MetadataExtractor.java</exclude-pattern>
    <exclude-pattern>**/BuiltInResolver.java</exclude-pattern>
    <exclude-pattern>**/JpqlQueryParser.java</exclude-pattern>

    <!-- CPD: Alternative strategy implementations (intentional duplication) -->
    <exclude-pattern>**/MethodHandleImplementation.java</exclude-pattern>
    <exclude-pattern>**/BytecodeTableGenerator.java</exclude-pattern>

    <!-- Concrete types for lock-free performance (LooseCoupling) -->
    <exclude-pattern>**/HashIndex.java</exclude-pattern>
    <exclude-pattern>**/RangeIndex.java</exclude-pattern>
    <exclude-pattern>**/StringPrefixIndex.java</exclude-pattern>

    <!-- Record component Javadoc (PMD false positive) -->
    <exclude-pattern>**/CompiledQuery.java</exclude-pattern>
</ruleset>
```

**Update `pom.xml` PMD configuration** to use this file:
```xml
<configuration>
    <rulesets>
        <ruleset>${maven.multiModuleProjectDirectory}/pmd-rules.xml</ruleset>
        <ruleset>${maven.multiModuleProjectDirectory}/pmd-excluded.xml</ruleset>
    </rulesets>
</configuration>
```

### Phase 3: Minor Code Tweaks (10 minutes)

#### 3.1 Fix RowIdBitSet AssignmentInOperand
**File:** `memris-core/src/main/java/io/memris/kernel/RowIdBitSet.java`

**Change:** Extract snapshot.size to local variable before array allocation

**Verification:**
```bash
mvn test -Dtest=RowIdBitSetTest
```

### Phase 4: Documentation (10 minutes)

#### 4.1 Create `docs/PMD_POLICY.md`
Document the PMD violation policy for future developers:

```markdown
# PMD Violation Policy

## Overview
Memris project uses PMD for code quality analysis but intentionally accepts certain violations that reflect our design philosophy:
- Lock-free, performance-optimized hot paths
- Zero-reflection in critical sections
- Build-time vs runtime architecture separation
- Alternative implementation strategies

## Accepted Violations

### God Classes
**Files:** MetadataExtractor, BuiltInResolver, JpqlQueryParser

**Rationale:**
- These are **build-time components**, not hot-path code
- Complexity is necessary for comprehensive annotation support and query planning
- Reflection is expensive; doing it once per entity is optimal
- Splitting would scatter related logic and hurt maintainability

### Concrete Type Usage (LooseCoupling)
**Files:** HashIndex, RangeIndex, StringPrefixIndex

**Rationale:**
- ConcurrentHashMap/ConcurrentSkipListMap chosen for lock-free performance
- Private fields, not part of public API
- Map interface doesn't expose lock-free guarantees needed for performance

### CPD Duplication
**Files:** MethodHandleImplementation, BytecodeTableGenerator

**Rationale:**
- Two **alternative implementation strategies** (MethodHandle vs Bytecode)
- Each implementation is used independently based on configuration
- Code generation is intentionally per-strategy for zero-reflection hot paths
- This is a valid Strategy Pattern implementation

### Missing Control Braces
**Files:** BuiltInResolver

**Rationale:**
- Concise style preferred for lock-free code patterns
- Single-statement if blocks are safe in Java
- Consistent with project's focus on minimal overhead

### AssignmentInOperand / AvoidLiteralsInIfCondition
**Files:** RowIdBitSet

**Rationale:**
- Intentional for performance-critical paths
- Literals like 0L, 1 are common in bit manipulation code

## Quick Fixes Applied

### @FunctionalInterface Annotations
**Files:** AuditProvider, IdGenerator

**Rationale:**
- Enables compiler enforcement of functional interface contract
- Improves IDE support and lambda compatibility
- Zero-risk, improves documentation

## Verification
To verify PMD compliance:
```bash
mvn clean pmd:check pmd:cpd-check
```

Expected result: 0 warnings (all intentional violations documented and excluded)
```

#### 4.2 Add Javadoc comments to complex classes

**MetadataExtractor.java:**
```java
/**
 * Extracts entity metadata via reflection at build time.
 *
 * <p>This class intentionally has high cognitive complexity as it handles:
 * - Multiple relationship types (ManyToOne, OneToOne, OneToMany, ManyToMany)
 * - Both Memris and JPA annotations
 * - Bidirectional relationship discovery
 * - Field-level and class-level metadata extraction
 *
 * <p><b>Complexity Rationale:</b> Reflection is expensive. Doing a single-pass
 * comprehensive extraction per entity type is optimal. Splitting this class
 * would scatter related logic and hurt maintainability.
 *
 * <p><b>Not a hot-path component:</b> This runs only once per entity type during
 * initialization. All hot-path code uses the generated tables via zero-reflection
 * access.
 */
public class MetadataExtractor {
    // ...
}
```

Similar comments for BuiltInResolver and JpqlQueryParser.

### Phase 5: Verification (5 minutes)

#### 5.1 Run PMD checks
```bash
mvn clean pmd:check pmd:cpd-check
```

**Expected Output:** 0 warnings

#### 5.2 Run full test suite
```bash
mvn clean test
```

**Expected Output:** All 669 tests pass

#### 5.3 Verify build artifacts
```bash
mvn clean install
```

**Expected Output:** Build succeeds with no quality tool warnings

## Files to Modify

### New Files
1. `memris-core/src/main/java/io/memris/core/AuditProvider.java` (1 line)
2. `memris-core/src/main/java/io/memris/core/IdGenerator.java` (1 line)
3. `docs/PMD_POLICY.md` (new file)
4. `pmd-excluded.xml` (new file)

### Modified Files
1. `pmd-rules.xml` (add excludes with comments, remove duplicate reference)
2. `pom.xml` (update PMD rulesets configuration)
3. `memris-core/src/main/java/io/memris/kernel/RowIdBitSet.java` (1 line)
4. `memris-core/src/main/java/io/memris/core/MetadataExtractor.java` (Javadoc comment)
5. `memris-core/src/main/java/io/memris/query/BuiltInResolver.java` (Javadoc comment)
6. `memris-core/src/main/java/io/memris/query/JpqlQueryParser.java` (Javadoc comment)

## Expected Outcome

### Before
- 919 PMD violations
- 73 CPD duplications
- Warnings flood build output
- Unclear which violations are intentional

### After
- 0 PMD violations reported
- 0 CPD duplications reported
- Clear documentation of design choices
- All 669 tests still pass
- Build output clean

## Rollback Plan

If issues arise:
1. Revert `pmd-rules.xml` changes
2. Remove `pmd-excluded.xml` reference from `pom.xml`
3. Remove Javadoc comments if desired
4. Revert `@FunctionalInterface` additions (optional)

**No code changes that affect behavior** - all changes are documentation and configuration.
