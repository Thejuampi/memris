# Plan: Improve Code Coverage from 60% to 70%+

## Current State Analysis

**Current Coverage: 59.9%** (2,262 missed lines out of 5,635 total)

**Root Cause**: The `io.memris.storage.heap` package (14 source files) is being excluded from Jacoco coverage reporting via pom.xml, artificially lowering the coverage percentage.

### Critical Uncovered Areas (Non-Generated Code)

These classes have 0% coverage and represent significant gaps:

| Class | Instructions | Package |
|-------|--------------|---------|
| `JpqlQueryParser.Parser` | 1,012 | io.memris.query |
| `PageColumnLong` | 490 | io.memris.storage.heap |
| `PageColumnInt` | 471 | io.memris.storage.heap |
| `JoinExecutorManyToMany` | 436 | io.memris.runtime |
| `AbstractTable` | 433 | io.memris.storage.heap |
| `PageColumnString` | 374 | io.memris.storage.heap |
| `MethodHandleImplementation` | 347 | io.memris.storage.heap |
| `TableGenerator` | 283 | io.memris.storage.heap |
| `SimpleTable` | 245 | io.memris.storage |
| `JoinCollectionMaterializer` | 168 | io.memris.runtime |

### Quick Wins (Small Classes, Easy Tests)

| Class | Instructions | Description |
|-------|--------------|-------------|
| `LockFreeFreeList` | 77 | Lock-free stack for row ID reuse |
| `StringIdIndex` | 77 | String ID to RowId index |
| `TypeConverterRegistry.*` | 20-24 each | 10 type converters (UUID, BigDecimal, etc.) |
| `FetchType` | 9 | Enum |
| `GenerationType` | 27 | Enum |
| `MemrisException` | 13 | Exception class |

## Target

**Goal**: Increase line coverage from **60% to 70%+** (10 percentage point increase)

## Implementation Plan

### Phase 1: Fix Coverage Configuration (CRITICAL)

**File**: `memris-core/pom.xml`

**Action**: Remove `io/memris/storage/heap/*` from Jacoco exclusions

**Rationale**: 
- These are actual source files (14 classes), NOT generated code
- Excluding them artificially deflates coverage by ~1,500+ instructions
- We've already written tests for PageColumn* classes that aren't being counted

**Change**:
```xml
<!-- BEFORE (excludes heap) -->
<excludes>
    <exclude>io/memris/storage/generated/**/*</exclude>
    <exclude>io/memris/storage/heap/*</exclude>
    <exclude>*$*</exclude>
</excludes>

<!-- AFTER (includes heap) -->
<excludes>
    <exclude>io/memris/storage/generated/**/*</exclude>
    <exclude>*$*</exclude>
</excludes>
```

**Expected Impact**: +5-8% coverage immediately (without new tests)

---

### Phase 2: High-Impact Tests (Big Uncovered Classes)

**Goal**: Cover the largest uncovered classes

#### 2.1 JPQL Parser Tests
**File**: `memris-core/src/test/java/io/memris/query/JpqlQueryParserParserTest.java`

Target: `JpqlQueryParser.Parser` (1,012 instructions, 0% coverage)

Test scenarios:
- SELECT queries with all clause types (WHERE, ORDER BY, GROUP BY, HAVING)
- UPDATE queries with SET clauses
- DELETE queries
- JOIN operations (INNER, LEFT, RIGHT)
- Complex expressions (nested, arithmetic, functions)
- Parameter binding (:param syntax)
- Error handling for invalid syntax

**Expected Coverage Gain**: +3-4%

#### 2.2 Join Executor Tests
**File**: `memris-core/src/test/java/io/memris/runtime/JoinExecutorManyToManyTest.java`

Target: `JoinExecutorManyToMany` (436 instructions, 0% coverage)

Test scenarios:
- Many-to-many relationship loading
- Join table queries
- Collection materialization

**Expected Coverage Gain**: +1-2%

#### 2.3 Table Implementation Tests
**File**: `memris-core/src/test/java/io/memris/storage/heap/TableImplementationTest.java`

Target: `MethodHandleImplementation`, `TableGenerator`, `AbstractTable`

Test scenarios:
- Table generation with different strategies
- MethodHandle-based table operations
- AbstractTable lifecycle methods

**Expected Coverage Gain**: +2-3%

---

### Phase 3: Quick Wins (Easy Tests, Good ROI)

**Goal**: Maximize coverage with minimal effort

#### 3.1 SimpleTable Tests
**File**: `memris-core/src/test/java/io/memris/storage/SimpleTableTest.java`

Target: `SimpleTable` (245 instructions, 0% coverage)

Test scenarios:
- Basic CRUD operations
- Row allocation and deallocation
- Column access

**Expected Coverage Gain**: +1%

#### 3.2 Utility Classes Tests
**File**: `memris-core/src/test/java/io/memris/storage/heap/UtilityClassesTest.java`

Targets:
- `LockFreeFreeList` (77 instructions)
- `StringIdIndex` (77 instructions)
- `TableMetadata` (31 instructions)
- `FieldMetadata` (18 instructions)

Test scenarios:
- Lock-free stack push/pop operations
- String ID index CRUD
- Metadata construction and access

**Expected Coverage Gain**: +1-2%

#### 3.3 Type Converter Tests
**File**: `memris-core/src/test/java/io/memris/core/converter/TypeConverterRegistryConvertersTest.java`

Targets: All inner converters in `TypeConverterRegistry` (10 classes, 20-24 instructions each):
- `UUIDConverter`
- `BigDecimalConverter`
- `BigIntegerConverter`
- `LocalDateLongConverter`
- `LocalDateTimeLongConverter`
- `InstantLongConverter`
- `DateLongConverter`
- `LocalTimeConverter`
- `SqlDateConverter`
- `SqlTimestampConverter`

Test scenarios:
- Forward and reverse conversion
- Null handling
- Edge cases (min/max values)

**Expected Coverage Gain**: +1-2%

---

### Phase 4: Runtime & Kernel Tests

**Goal**: Fill gaps in runtime execution

#### 4.1 Join Collection Materializer Tests
**File**: `memris-core/src/test/java/io/memris/runtime/JoinCollectionMaterializerTest.java`

Target: `JoinCollectionMaterializer` (168 instructions, 0% coverage)

Test scenarios:
- Collection loading for joins
- Lazy vs eager loading

#### 4.2 Runtime Handler Completion
**File**: Extend existing type handler tests

Complete coverage for:
- `BooleanTypeHandler` - IS_TRUE, IS_FALSE operations
- `FloatTypeHandler` - Compare operations
- `DateTypeHandler` - All date comparison operations

---

### Phase 5: Edge Cases & Integration

**Goal**: Integration tests and edge case coverage

#### 5.1 Integration Tests
**File**: `memris-core/src/test/java/io/memris/integration/EndToEndRepositoryTest.java`

Test scenarios:
- Full repository lifecycle (save, query, update, delete)
- Complex queries with multiple predicates
- Transaction-like operations (if supported)

#### 5.2 Error Handling Tests
Test exception paths and error conditions in:
- Query parsing
- Entity materialization
- Type conversions

## Expected Coverage Impact

| Phase | Action | Expected Gain |
|-------|--------|---------------|
| Phase 1 | Remove heap exclusion from pom.xml | +5-8% |
| Phase 2 | JPQL Parser + Join tests | +4-6% |
| Phase 3 | Quick wins (SimpleTable, utilities, converters) | +3-5% |
| Phase 4 | Runtime completion | +2-3% |
| Phase 5 | Integration & edge cases | +1-2% |
| **Total** | | **+15-24%** |

**Projected Final Coverage**: 75-84% (target: 70%+)

## Files to Modify

### Configuration Changes
1. `memris-core/pom.xml` - Remove heap exclusion

### New Test Files
1. `memris-core/src/test/java/io/memris/query/JpqlQueryParserParserTest.java`
2. `memris-core/src/test/java/io/memris/runtime/JoinExecutorManyToManyTest.java`
3. `memris-core/src/test/java/io/memris/storage/heap/TableImplementationTest.java`
4. `memris-core/src/test/java/io/memris/storage/SimpleTableTest.java`
5. `memris-core/src/test/java/io/memris/storage/heap/UtilityClassesTest.java`
6. `memris-core/src/test/java/io/memris/core/converter/TypeConverterRegistryConvertersTest.java`
7. `memris-core/src/test/java/io/memris/runtime/JoinCollectionMaterializerTest.java`
8. `memris-core/src/test/java/io/memris/integration/EndToEndRepositoryTest.java`

## Verification Steps

After each phase:
```bash
mvn.cmd clean test jacoco:report -pl memris-core
```

Check:
- `memris-core/target/site/jacoco/index.html` for overall coverage
- Specific class coverage in package reports
- No test failures

## Success Criteria

1. **Line coverage >= 70%**
2. All new tests pass
3. No regression in existing tests
4. `io.memris.storage.heap` package shows in coverage report
5. Major uncovered classes (JpqlQueryParser.Parser, SimpleTable) have >50% coverage

## Critical Path

**Phase 1 (pom.xml change) is CRITICAL** - without it, we're testing code that doesn't count toward coverage metrics.

**Recommended Order**:
1. Phase 1 first (configuration fix) - immediate +5-8% boost
2. Phase 3 quick wins (high ROI) - +3-5% with minimal effort
3. Phase 2 high-impact (big classes) - +4-6%
4. Phase 4 & 5 to reach 70%+ target
