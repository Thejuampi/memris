# Concurrency Safety Plan (CAS-only, Multi-writer)

## Goal
Provide lock-free, multi-writer safety for saves/deletes using CAS-only primitives, while allowing eventual index consistency (no strict index/row atomicity).

## Design Summary
- Use **row-level seqlock with CAS acquisition** so only one writer mutates a row at a time and readers can retry on concurrent writes.
- Make **row liveness authoritative** (tombstone + generation). Indexes become advisory and are validated at query time to avoid false positives.
- Ensure **publish ordering**: write columns → publish → end seqlock → update indexes (eventual).

## Planned Changes
1. **Row seqlock acquisition (CAS) + helper API**
   - Update `AbstractTable.beginSeqLock(int rowIndex)` to CAS from even→odd (spin/backoff on odd or failed CAS).
   - Keep `endSeqLock` as increment to even.
   - Add a small helper (e.g., `tryBeginSeqLock` or `beginSeqLock` loop) to avoid multiple writers entering the same row.
   - File: `memris-core/src/main/java/io/memris/storage/heap/AbstractTable.java`.

2. **Wire seqlock into insert + delete (write path)**
   - In `MethodHandleImplementation.InsertInterceptor`:
     - begin seqlock → write columns → publish columns → end seqlock → update ID index → increment row count.
     - This prevents ID lookups from seeing partially-written rows.
   - In `MethodHandleImplementation.TombstoneInterceptor`:
     - begin seqlock before tombstone (retry if writer active).
     - tombstone first, then remove from ID index (eventual consistency; stale index entries are filtered).
   - File: `memris-core/src/main/java/io/memris/storage/heap/MethodHandleImplementation.java`.

3. **Use seqlock for typed reads**
   - Wrap `readLong/readInt/readString/isPresent` via `AbstractTable.readWithSeqLock` so row reads never observe partial writes.
   - Implement in `ReadInterceptor` and `PresentInterceptor` using the row index and a supplier to read the column.
   - File: `memris-core/src/main/java/io/memris/storage/heap/MethodHandleImplementation.java`.

4. **Per-row generation in selections**
   - Add a GeneratedTable method to expose per-row generation (e.g., `rowGeneration(int rowIndex)` or `packRef(int rowIndex)`), implemented in `AbstractTable`.
   - Update `selectionFromRows(...)` to pack with each row’s generation, not `currentGeneration`.
   - This prevents stale refs when rows are reused.
   - Files:
     - `memris-core/src/main/java/io/memris/storage/GeneratedTable.java`
     - `memris-core/src/main/java/io/memris/storage/heap/AbstractTable.java`
     - `memris-core/src/main/java/io/memris/storage/heap/MethodHandleImplementation.java`
     - `memris-core/src/main/java/io/memris/runtime/RepositoryRuntime.java`.

5. **Index query validation (eventual consistency)**
   - In `selectionFromRows(...)`, filter rows that are tombstoned or generation-mismatched via `table.isLive(...)` (using per-row generation).
   - This allows eventual index updates without incorrect query results.
   - File: `memris-core/src/main/java/io/memris/runtime/RepositoryRuntime.java`.

6. **Optional: Free-list ABA protection**
   - If needed under heavy concurrent delete/insert, replace Treiber head with stamped CAS to avoid ABA.
   - File: `memris-core/src/main/java/io/memris/storage/heap/LockFreeFreeList.java`.

7. **Docs update**
   - Update concurrency docs to reflect multi-writer lock-free semantics and eventual index consistency.
   - Files: `docs/CONCURRENCY.md`, `README.md`.

## Key Files to Modify
- `memris-core/src/main/java/io/memris/storage/heap/AbstractTable.java`
- `memris-core/src/main/java/io/memris/storage/heap/MethodHandleImplementation.java`
- `memris-core/src/main/java/io/memris/storage/GeneratedTable.java`
- `memris-core/src/main/java/io/memris/runtime/RepositoryRuntime.java`
- `memris-core/src/main/java/io/memris/storage/heap/LockFreeFreeList.java` (optional)
- `docs/CONCURRENCY.md`, `README.md`

## Verification
- Run core tests:
  - `mvn.cmd -q -e -pl memris-core test`
- If targeted tests exist, run concurrency-focused suites (e.g., `*ConcurrencyTest` in `memris-core/src/test/java/io/memris/storage/heap`).
- Add/extend tests if needed:
  - Concurrent save/delete stress test.
  - Seqlock read consistency test.
  - Index stale-entry filtering test.
