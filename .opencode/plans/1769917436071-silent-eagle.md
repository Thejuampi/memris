# Plan: Precompiled Executors for Queries, Ordering/Projection, and Save/Index

## Goal
- Apply the precompiled-executor pattern across query condition execution, ordering/projection, and save/index paths to reduce hot-path branching.
- Add/extend tests first for each area, then refactor with minimal public API impact.

## Scope Summary
- **Query conditions**: remove per-call operator/type branching in `RepositoryRuntime.selectWithIndex` and `HeapRuntimeKernel.executeCondition` by precompiling executors per condition.
- **Ordering/projection**: precompute sort/projection handlers by `TypeCodes` and order-by shape; avoid repeated `switch`/type checks per query.
- **Save/index**: precompute ID resolvers and index value readers/writers to avoid repeated type switching and converter checks.

## Tests First (extend existing tests)
1. **Query condition paths**
   - Extend `memris-core/src/test/java/io/memris/runtime/RepositoryRuntimeTest.java` and `memris-core/src/test/java/io/memris/runtime/TestEntityRepository.java`:
     - Add derived-query method to cover `IN` (e.g., `findByNameIn`) and test List/array inputs.
   - Extend `memris-core/src/test/java/io/memris/core/QueryAnnotationIntegrationTest.java`:
     - Add/update tests for `IN`, `NOT IN`, and `BETWEEN` via @Query integration to validate runtime execution, not just parsing.

2. **Ordering / projection**
   - Extend `memris-core/src/test/java/io/memris/runtime/RepositoryRuntimeTest.java`:
     - Add multi-column order-by query (e.g., age asc, name desc) to cover `buildOrderKeys` multi-column paths.
   - Extend `memris-core/src/test/java/io/memris/core/QueryAnnotationIntegrationTest.java`:
     - Keep `OrderSummary` projection test and add an order-by projection query to ensure projection + ordering works together.

3. **Save / index**
   - Extend `memris-core/src/test/java/io/memris/runtime/RepositoryRuntimeTest.java`:
     - Add an indexed test entity/repository using `io.memris.Index` to ensure index-backed queries are exercised (add/update/delete then query by indexed field).
   - Extend `memris-core/src/test/java/io/memris/core/QueryAnnotationIntegrationTest.java`:
     - Add update and delete @Query integration tests to cover modify paths (`UPDATE ... SET ... WHERE ...`, `DELETE FROM ... WHERE ...`).

## Implementation Steps
1. **Query Condition Executors**
   - Add internal executor interface (e.g., `ConditionExecutor`) under `io.memris.runtime`.
   - Extend `CompiledQuery` to optionally carry per-condition executors or add a parallel structure in `RepositoryPlan` keyed by query index.
   - Build executors during query compilation (best in `QueryCompiler` or immediately after in `RepositoryEmitter`/`MemrisRepositoryFactory`) using:
     - resolved column index
     - operator
     - `ignoreCase`
     - index availability (pre-resolve field name and index predicate operator)
   - Update `RepositoryRuntime.selectWithIndex` / `executeConditions` to call executors instead of branching.
   - Update `HeapRuntimeKernel.executeCondition` to use specialized executor when provided (fallback to existing logic).

2. **Ordering / Projection Executors**
   - Add internal `OrderExecutor` (single-column, multi-column, top-k) built once per query from `CompiledQuery.CompiledOrderBy[]` and `TypeCodes`.
   - Add internal `ProjectionExecutor` that precomputes per-step readers (column index + type + converter) and constructor handles.
   - Store these executors in `CompiledQuery` or plan structures and use them in `RepositoryRuntime.executeFind` in place of repeated `TypeCodes` switches.

3. **Save / Index Executors**
   - Add precompiled ID resolver (string vs number) and index readers/writers in `RepositoryPlan` or `EntityMetadata`-adjacent helper.
   - Replace `readIndexValue`/`updateIndexesOnInsert`/`updateIndexesOnDelete` branching with precomputed readers and converter hooks.
   - Precompute converter presence per field to avoid per-call map lookup.

## Files to Modify (Expected)
- Runtime/query execution:
  - `memris-core/src/main/java/io/memris/runtime/RepositoryRuntime.java`
  - `memris-core/src/main/java/io/memris/runtime/HeapRuntimeKernel.java`
  - `memris-core/src/main/java/io/memris/query/CompiledQuery.java`
  - `memris-core/src/main/java/io/memris/query/QueryCompiler.java`
- Executors (new internal types):
  - `memris-core/src/main/java/io/memris/runtime/ConditionExecutor.java` (new)
  - `memris-core/src/main/java/io/memris/runtime/OrderExecutor.java` (new)
  - `memris-core/src/main/java/io/memris/runtime/ProjectionExecutor.java` (new)
- Save/index helpers:
  - `memris-core/src/main/java/io/memris/runtime/RepositoryPlan.java`
  - `memris-core/src/main/java/io/memris/runtime/RepositoryMethodBinding.java`
  - `memris-core/src/main/java/io/memris/repository/RepositoryEmitter.java`
  - `memris-core/src/main/java/io/memris/repository/MemrisRepositoryFactory.java`
- Tests:
  - `memris-core/src/test/java/io/memris/runtime/RepositoryRuntimeTest.java`
  - `memris-core/src/test/java/io/memris/runtime/TestEntityRepository.java`
  - `memris-core/src/test/java/io/memris/core/QueryAnnotationIntegrationTest.java`
  - New indexed test entity/repository under `memris-core/src/test/java/io/memris/runtime/`

## Verification
- Compile: `mvn.cmd -q -e compile`
- Core tests: `mvn.cmd -q -e -pl memris-core test`
- If needed: `mvn.cmd -q -e -pl memris-core test -Dtest=RepositoryRuntimeTest,QueryAnnotationIntegrationTest`

## Notes/Risks
- Keep executor structures internal and avoid public API changes.
- Ensure executors do not share mutable arrays between calls.
- Maintain `TypeCodes`-based dispatch and zero-reflection hot paths.
