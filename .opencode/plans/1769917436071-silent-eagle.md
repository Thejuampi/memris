# Plan: Add Map Return Support (Grouping + Count)

## Goal
- Add Map return support for derived grouping queries:
  - `findAllGroupingByXxx` → `Map<K, List<T>>`
  - `countByXxx` with `Map` return type → `Map<K, Long>`
- Require caller-provided record classes for multi-field grouping (not in MVP).
- Keep changes focused; update tests first (TDD), then refactor.

## Scope Summary
- **Parsing**: detect `GroupingBy` pattern and `Map` return types.
- **Planning**: add `Grouping` metadata to `LogicalQuery` and propagate to `CompiledQuery`.
- **Runtime**: build `Map` results for LIST and COUNT groupings.
- **Tests**: add failing tests first for `findAllGroupingByXxx` and `countByXxx` returning `Map`.

## Tests First (TDD)
1. **Grouping List**
   - `memris-core/src/test/java/io/memris/runtime/TestEntityRepository.java`: add `Map<String, List<TestEntity>> findAllGroupingByDepartment()`.
   - `memris-core/src/test/java/io/memris/runtime/RepositoryRuntimeTest.java`: add test `shouldGroupEntitiesByDepartment`.

2. **Grouping Count**
   - Add `Map<String, Long> countByDepartment()` to repository interface.
   - Add test `shouldCountEntitiesByDepartment` verifying counts.

## Implementation Steps
1. **Logical/Compiled Query Shape**
   - Add `Grouping` to `LogicalQuery` with key property and value type (LIST/COUNT).
   - Add `CompiledGrouping` to `CompiledQuery` with resolved column index + value type.
   - Update `QueryCompiler` to compile grouping via `resolveColumnIndex`.

2. **Query Parsing / Planning**
   - In `QueryPlanner`:
     - Detect `findAllGroupingByXxx` and set ReturnKind = `MANY_MAP`.
     - Support `countByXxx` returning `Map` as `MANY_MAP` with COUNT value type.
     - Normalize grouping property name to camelCase.
     - Skip `By` validation for grouping methods only.
   - In `JpqlQueryParser`, update `LogicalQuery.of(...)` calls to include grouping parameter (null for now).

3. **Runtime Execution**
   - In `RepositoryRuntime.executeFind`, add handling for `MANY_MAP`:
     - Use `CompiledGrouping` to read grouping key per row.
     - For LIST: `Map<K, List<T>>` grouping.
     - For COUNT: `Map<K, Long>` count aggregation.

4. **Refactor / Cleanup**
   - Update equality/hash in `LogicalQuery` to include grouping.
   - Update test helpers that construct `LogicalQuery` instances with new grouping parameter.

## Files to Modify (Expected)
- `memris-core/src/main/java/io/memris/query/LogicalQuery.java`
- `memris-core/src/main/java/io/memris/query/CompiledQuery.java`
- `memris-core/src/main/java/io/memris/query/QueryPlanner.java`
- `memris-core/src/main/java/io/memris/query/QueryCompiler.java`
- `memris-core/src/main/java/io/memris/query/JpqlQueryParser.java`
- `memris-core/src/main/java/io/memris/runtime/RepositoryRuntime.java`
- Tests:
  - `memris-core/src/test/java/io/memris/runtime/RepositoryRuntimeTest.java`
  - `memris-core/src/test/java/io/memris/runtime/TestEntityRepository.java`
  - `memris-core/src/test/java/io/memris/core/plan/entities/QueryPlannerIntegrationTest.java`

## Verification
- Targeted: `mvn test -pl memris-core -Dtest=RepositoryRuntimeTest#shouldGroupEntitiesByDepartment,RepositoryRuntimeTest#shouldCountEntitiesByDepartment`
- Full: `mvn test -pl memris-core`

## Notes/Risks
- Map return types must be explicit; other Map return signatures should error if no grouping is detected.
- Grouping key resolution currently supports direct property paths only.
