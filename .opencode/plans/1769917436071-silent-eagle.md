# Plan: Multi-Field Grouping With Record Keys

## Goal
- Add JPQL GROUP BY/HAVING with record-key grouping support.
- Extend derived grouping to support SET grouping and parameterized grouping via `By...GroupingBy...` patterns.
- Keep changes focused; update tests first (TDD), then refactor.

## Scope Summary
- **JPQL Lexer/Parser**: add GROUP/HAVING tokens, grammar support, and AST fields for group keys + having predicate.
- **JPQL Planning/Compilation**: compile grouping keys (multi-field) to `CompiledGrouping` and allow Map return shapes.
- **Runtime**: reuse grouping map execution for JPQL group-by results (COUNT and entity list/set).
- **Derived Parsing**: add `find...GroupingBy...AsSet` and `findBy...GroupingBy...` patterns.
- **Tests**: add failing tests for JPQL group-by/having and derived SET/parameterized grouping.

## Tests First (TDD)
1. **JPQL Group By + Having (COUNT)**
   - Add repository method with `@Query("select count(e) from TestEntity e group by e.department, e.age having count(e) > :min")` returning `Map<DepartmentAgeKey, Long>`.
   - Add test in `memris-core/src/test/java/io/memris/runtime/RepositoryRuntimeTest.java` to verify grouped counts and HAVING filter.

2. **JPQL Group By (entity list)**
   - Add repository method with `@Query("select e from TestEntity e group by e.department, e.age")` returning `Map<DepartmentAgeKey, List<TestEntity>>`.
   - Add test to verify grouped entity lists.

3. **Derived SET grouping**
   - Add `Map<String, Set<TestEntity>> findAllGroupingByDepartmentAsSet()` (and multi-field variant if desired).
   - Add test to verify set grouping behavior.

4. **Derived parameterized grouping**
   - Add `Map<DepartmentAgeKey, Long> countByNameGroupingByDepartmentAndAge(String name)`.
   - Add test to verify grouped counts filtered by name.

## Implementation Steps
1. **JPQL Lexer/AST/Parser**
   - Add GROUP and HAVING tokens in `memris-core/src/main/java/io/memris/query/jpql/JpqlLexer.java`.
   - Extend `JpqlAst.Query` to carry `groupBy` (list of property paths) and optional `having` predicate.
   - Update `JpqlQueryParser` to parse `GROUP BY` and `HAVING` after `WHERE`/before `ORDER BY`.

2. **JPQL Planning/Compilation**
   - Extend `JpqlQueryParser.parse(...)` to build `LogicalQuery.Grouping` for JPQL queries when group-by present.
   - Validate Map return shapes: COUNT → `Map<RecordKey, Long>`; SELECT entity → `Map<RecordKey, List<T>>`.
   - Reuse existing `QueryCompiler` grouping compilation (multi-field + record validation).

3. **Runtime Execution**
   - Reuse `RepositoryRuntime.buildMapResult` for JPQL group-by execution.
   - Add HAVING evaluation path (after grouping) for COUNT (predicate against group count and/or grouped key values).

4. **Derived Grouping Extensions**
   - Extend `QueryPlanner.extractGrouping` to detect `...GroupingBy...AsSet` → `GroupValueType.SET`.
   - Add parameterized grouping parsing for `findBy...GroupingBy...` pattern while preserving existing validations.

5. **Docs/Limitations**
   - Update `docs/QUERY.md` and `README.md` to reflect GROUP BY/HAVING support and constraints.

## Files to Modify (Expected)
- `memris-core/src/main/java/io/memris/query/jpql/JpqlLexer.java`
- `memris-core/src/main/java/io/memris/query/jpql/JpqlAst.java`
- `memris-core/src/main/java/io/memris/query/JpqlQueryParser.java`
- `memris-core/src/main/java/io/memris/query/LogicalQuery.java`
- `memris-core/src/main/java/io/memris/query/QueryPlanner.java`
- `memris-core/src/main/java/io/memris/query/QueryCompiler.java`
- `memris-core/src/main/java/io/memris/runtime/RepositoryRuntime.java`
- Docs:
  - `docs/QUERY.md`
  - `README.md`
- Tests:
  - `memris-core/src/test/java/io/memris/runtime/RepositoryRuntimeTest.java`
  - `memris-core/src/test/java/io/memris/runtime/TestEntityRepository.java`
  - `memris-core/src/test/java/io/memris/runtime/DepartmentAgeKey.java`

## Verification
- Targeted: `mvn.cmd -q -e -pl memris-core test -Dtest=RepositoryRuntimeTest#shouldGroupEntitiesByDepartmentAndAge,RepositoryRuntimeTest#shouldCountEntitiesByDepartmentAndAge,RepositoryRuntimeTest#shouldGroupEntitiesByDepartmentAndAgeViaJpql,RepositoryRuntimeTest#shouldCountEntitiesByDepartmentAndAgeViaJpqlHaving`
- Full: `mvn.cmd -q -e -pl memris-core test`

## Notes/Risks
- Map return types must be explicit; other Map return signatures should error if no grouping is detected.
- Grouping key resolution currently supports direct property paths only.
- Record component names and types must match grouping properties or a clear error is thrown.
- HAVING initially limited to COUNT-based predicates (no SUM/AVG/MIN/MAX).
