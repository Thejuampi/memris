# Plan: Record Projections (Select Aliases Required)

## Goal
Add record-only projections for `@Query` methods using a SELECT list with aliases that match record component names. Allow nested paths through to-one relationships; no JavaBean projections; immutable records only.

## Scope & Constraints
- **Only records** (`Class#isRecord`) as projection targets.
- **Only @Query** methods; derived queries cannot return projections.
- **SELECT list required** with aliases that match record component names.
- **Nested paths allowed** only through to-one relationships (`@ManyToOne`, `@OneToOne`), not collections.
- **No JPQL constructor expressions** (`select new ...`) and no JavaBean setters.
- **Out of scope**: transactions, native SQL, pagination/Sort parameters.

## Approach
1. **JPQL select list**: extend JPQL AST + parser to capture `SELECT` items with aliases.
2. **Projection planning**: in `JpqlQueryParser`, detect record projections (List<Record>/Optional<Record>) and validate:
   - select list present
   - aliases match record component names
   - nested paths are only to-one
   - component type assignable to entity field type
3. **Logical/compiled projection spec**: carry projection info through `LogicalQuery` and `CompiledQuery` (projection type + compiled paths).
4. **Compile join paths for projections**: in `QueryCompiler`, resolve projection paths and record join steps for nested paths.
5. **Runtime materialization**: in `RepositoryRuntime`, if projection spec exists, build record instances by:
   - resolving join chains for nested paths
   - reading column values from target tables
   - invoking record canonical constructor via `MethodHandle`
6. **Validation + errors**: throw clear errors when projection rules are violated (no aliases, collection paths, non-record returns).

## Key Files
- `memris-core/src/main/java/io/memris/query/jpql/JpqlAst.java`
- `memris-core/src/main/java/io/memris/query/jpql/JpqlLexer.java`
- `memris-core/src/main/java/io/memris/spring/plan/JpqlQueryParser.java`
- `memris-core/src/main/java/io/memris/query/LogicalQuery.java`
- `memris-core/src/main/java/io/memris/query/CompiledQuery.java`
- `memris-core/src/main/java/io/memris/query/QueryCompiler.java`
- `memris-core/src/main/java/io/memris/runtime/RepositoryRuntime.java`

## Tests
- `memris-core/src/test/java/io/memris/spring/plan/JpqlQueryPlannerTest.java`
  - verify select list + alias validation for record projections
  - reject non-record return types
  - reject collection path projections
- `memris-core/src/test/java/io/memris/spring/QueryAnnotationIntegrationTest.java`
  - List<Record> and Optional<Record> projections
  - nested path via to-one relationship

## Verification
`mvn.cmd -q -e -pl memris-core test`
