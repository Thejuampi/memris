# Plan: Replace System.properties with Configuration Builder

## Problem
Currently using `System.getProperty()` in `TableImplementationStrategy.create()` and tests. This is:
- Hard to test (requires setting system properties)
- Global state (affects all code)
- Not type-safe
- Hard to discover what options are available

## Solution
Create a `MemrisConfiguration` builder pattern that is passed to components that need configuration.

## Design

### 1. Create MemrisConfiguration

**File:** `memris-core/src/main/java/io/memris/spring/MemrisConfiguration.java`

```java
public final class MemrisConfiguration {
    // Table implementation
    private final TableImplementation tableImplementation;
    
    // Table sizing
    private final int defaultPageSize;
    private final int defaultMaxPages;
    
    // ID generation
    private final IdGenerationStrategy idGenerationStrategy;
    
    // Sorting
    private final boolean enableParallelSorting;
    private final int parallelSortThreshold;
    
    // Builder factory
    public static Builder builder() { return new Builder(); }
    
    // Getters
    public TableImplementation tableImplementation() { return tableImplementation; }
    public int defaultPageSize() { return defaultPageSize; }
    // ... etc
    
    public static class Builder {
        private TableImplementation tableImplementation = TableImplementation.BYTECODE;
        private int defaultPageSize = 1024;
        private int defaultMaxPages = 1024;
        private IdGenerationStrategy idGenerationStrategy = IdGenerationStrategy.AUTO;
        private boolean enableParallelSorting = true;
        private int parallelSortThreshold = 1000;
        
        public Builder tableImplementation(TableImplementation impl) {
            this.tableImplementation = impl;
            return this;
        }
        
        public Builder defaultPageSize(int size) {
            this.defaultPageSize = size;
            return this;
        }
        
        public Builder defaultMaxPages(int pages) {
            this.defaultMaxPages = pages;
            return this;
        }
        
        public MemrisConfiguration build() {
            return new MemrisConfiguration(this);
        }
    }
    
    public enum TableImplementation {
        BYTECODE, METHOD_HANDLE
    }
}
```

### 2. Update MemrisRepositoryFactory

**File:** `memris-core/src/main/java/io/memris/spring/MemrisRepositoryFactory.java`

**Changes:**
- Add `MemrisConfiguration configuration` field
- Add constructor accepting `MemrisConfiguration`
- Default constructor uses `MemrisConfiguration.builder().build()`
- Pass configuration to RepositoryEmitter and TableGenerator

### 3. Update RepositoryEmitter

**File:** `memris-core/src/main/java/io/memris/spring/scaffold/RepositoryEmitter.java`

**Changes:**
- Add constructor accepting `MemrisConfiguration`
- Use `configuration.tableImplementation()` to decide table strategy
- Pass configuration through to table generation

### 4. Update TableGenerator

**File:** `memris-core/src/main/java/io/memris/storage/heap/TableGenerator.java`

**Changes:**
- Change `generate(TableMetadata)` to `generate(TableMetadata, MemrisConfiguration)`
- Use `configuration.tableImplementation()` to select strategy
- Remove `TableImplementationStrategy.create()` method (or deprecate)

### 5. Remove System.properties Usage

**Files to update:**
- `TableImplementationStrategy.java` - Remove `create()` method that reads system property
- `TableGeneratorStrategyTest.java` - Update tests to use configuration builder instead of system properties
- Any other tests using `System.setProperty`

## Implementation Order

### Phase 1: Create Configuration (TDD)

1. **Test:** Create `MemrisConfigurationTest.java`
   - Test builder pattern
   - Test default values
   - Test custom values

2. **Implement:** Create `MemrisConfiguration.java`
   - Follow RepositoryPlan.Builder pattern
   - Immutable configuration object

**Commit:** `feat: add MemrisConfiguration builder for type-safe configuration`

### Phase 2: Pass Configuration to Factory

1. **Test:** Update `MemrisRepositoryFactoryTest.java`
   - Test factory accepts configuration
   - Test default configuration works

2. **Implement:** Update `MemrisRepositoryFactory.java`
   - Add configuration field
   - Add constructor accepting configuration

**Commit:** `feat: pass MemrisConfiguration to MemrisRepositoryFactory`

### Phase 3: Pass Configuration to Emitter

1. **Test:** Update `RepositoryEmitterTest.java`
   - Test emitter uses configuration for table implementation

2. **Implement:** Update `RepositoryEmitter.java`
   - Accept configuration in constructor
   - Pass to TableGenerator

**Commit:** `feat: pass MemrisConfiguration through RepositoryEmitter`

### Phase 4: Update TableGenerator

1. **Test:** Update `TableGeneratorTest.java` and `TableGeneratorStrategyTest.java`
   - Test table implementation selection via configuration
   - Remove system property usage from tests

2. **Implement:** Update `TableGenerator.java`
   - Accept configuration parameter
   - Use configuration to select implementation strategy
   - Remove `TableImplementationStrategy.create()` usage

3. **Implement:** Update `TableImplementationStrategy.java`
   - Remove or deprecate `create()` method
   - Make strategies instantiable directly

**Commit:** `feat: use MemrisConfiguration for table implementation selection`

### Phase 5: Clean Up System Properties

1. **Update Tests:** Remove all `System.setProperty` calls in tests
   - Use configuration builder instead

2. **Update Documentation:** Update any docs mentioning system properties

**Commit:** `refactor: remove System.properties usage in favor of configuration builder`

## Verification

```bash
# All tests pass
mvn.cmd -q -e -pl memris-core test

# Configuration tests
mvn.cmd -q -e -pl memris-core test -Dtest=MemrisConfigurationTest

# Factory with configuration
mvn.cmd -q -e -pl memris-core test -Dtest=MemrisRepositoryFactoryTest

# Table implementation selection
mvn.cmd -q -e -pl memris-core test -Dtest=TableGeneratorStrategyTest
```

## Benefits

1. **Type-safe:** Configuration is validated at compile time
2. **Testable:** Easy to create different configurations for tests
3. **Discoverable:** IDE autocomplete shows available options
4. **No global state:** Each MemrisRepositoryFactory can have its own config
5. **Immutable:** Configuration can't be changed after creation
6. **Fluent API:** Easy to read and write configuration code

## Example Usage

```java
// Default configuration
MemrisRepositoryFactory factory = new MemrisRepositoryFactory();

// Custom configuration
MemrisConfiguration config = MemrisConfiguration.builder()
    .tableImplementation(TableImplementation.METHOD_HANDLE)
    .defaultPageSize(2048)
    .enableParallelSorting(false)
    .build();

MemrisRepositoryFactory factory = new MemrisRepositoryFactory(config);
```
