## Plan: Concurrency Fixes + Low-Risk Perf

Goal: validate the concurrency analysis and implement the requested correctness fixes plus low-risk performance improvements, keeping behavior and APIs stable.

Scope (per user)
- Correctness fixes: per-table ID counter, thread-safe TypeHandlerRegistry, volatile Node.next, monotonic PageColumn publish.
- Low-risk perf: LockFreeFreeList size as approximate non-atomic, thread-local sort buffers in RepositoryRuntime.

Constraints
- Preserve existing query/scan semantics and public APIs.
- Keep hot-path operations lock-free; avoid synchronized blocks in scan/read/write paths.
- Maintain published monotonicity and current seqlock behavior.
- Keep result arrays newly allocated (scratch buffers only for internal sorting).

Implementation Steps
1) Per-table ID counter
   - File: `memris-core/src/main/java/io/memris/runtime/RepositoryRuntime.java`
   - Replace static `ID_COUNTER` with an instance field `idCounter`.
   - Initialize `idCounter` in the constructor with `new AtomicLong(1L)` to preserve current starting behavior.
   - Update `generateNextId()` to return `idCounter.getAndIncrement()`.
   - Note: does not seed from existing max ID; same behavior as today but scoped per repository/table.

2) TypeHandlerRegistry thread-safety
   - File: `memris-core/src/main/java/io/memris/runtime/TypeHandlerRegistry.java`
   - Replace `HashMap` fields with `ConcurrentHashMap`.
   - Keep current API; register/remove/clear remain safe for concurrent access.
   - Leave cross-map consistency as best-effort (same as today) but safe under concurrent reads.

3) LockFreeFreeList visibility + approximate size
   - File: `memris-core/src/main/java/io/memris/storage/heap/LockFreeFreeList.java`
   - Mark `Node.next` as `volatile` to ensure safe publication through CAS on `head`.
   - Replace `AtomicInteger size` with `volatile int size` and use `size++/size--` in push/pop.
   - Update size Javadoc to emphasize approximate/stale semantics.
   - Verify `size()` is not used for correctness (only metrics).

4) PageColumn publish monotonicity under concurrency
   - Files:
     - `memris-core/src/main/java/io/memris/storage/heap/PageColumnInt.java`
     - `memris-core/src/main/java/io/memris/storage/heap/PageColumnLong.java`
     - `memris-core/src/main/java/io/memris/storage/heap/PageColumnString.java`
   - Keep `published` as `volatile int` but add CAS-based monotonic updates.
   - Use `AtomicIntegerFieldUpdater` per class to implement:
     - read current
     - return if `newPublished <= current`
     - CAS loop to update
   - Leave `publishedCount()` and scan reads as plain volatile reads.

5) Thread-local sort buffers
   - File: `memris-core/src/main/java/io/memris/runtime/RepositoryRuntime.java`
   - Add a `ThreadLocal<SortBuffers>` with reusable scratch arrays (int/long/float/double/String keys + boolean present).
   - Update `sortByIntColumn`, `sortByLongColumn`, `sortByFloatColumn`, `sortByDoubleColumn`, `sortByStringColumn`, and `topKInt/topKLong/topKString` to reuse scratch arrays.
   - Keep returned arrays newly allocated (`rows.clone()`, `new int[k]` for topK results).
   - Leave multi-column `OrderKeyBuilder` allocations unchanged to avoid scope creep.

Risks / Notes
- Per-table ID counter changes global uniqueness across tables; this is the intended behavior and matches the analysis.
- Thread-local buffers retain memory in long-lived threads; buffers should grow only as needed.
- PageColumn CAS adds a small CAS cost on publish; protects monotonicity under concurrent writers.

Critical Files
- `memris-core/src/main/java/io/memris/runtime/RepositoryRuntime.java`
- `memris-core/src/main/java/io/memris/runtime/TypeHandlerRegistry.java`
- `memris-core/src/main/java/io/memris/storage/heap/LockFreeFreeList.java`
- `memris-core/src/main/java/io/memris/storage/heap/PageColumnInt.java`
- `memris-core/src/main/java/io/memris/storage/heap/PageColumnLong.java`
- `memris-core/src/main/java/io/memris/storage/heap/PageColumnString.java`

Verification
- Targeted: `mvn.cmd -q -e -pl memris-core test -Dtest=*ConcurrencyTest`
- Spot checks: `mvn.cmd -q -e -pl memris-core test -Dtest=RepositoryRuntimeTest,TypeHandlerRegistryTest,PageColumnConcurrencyTest`
- Full: `mvn.cmd -q -e -pl memris-core test`
