# Plan: Implement CRITICAL Sections for Concurrency Documentation

## Goal
Review and enhance the CONCURRENCY.md documentation with comprehensive CRITICAL sections that accurately reflect the actual code implementation. The documentation must emphasize "blazing fast, no reflection" principles.

## Current State Analysis

### What's Already Documented in CONCURRENCY.md
✅ Thread-safe operations table (ID generation, index lookups, query scans)
✅ Non-thread-safe operations table (saves, deletes, row allocation)
✅ 4 Critical Issues identified with code examples
✅ Concurrency workarounds section
✅ Improvement roadmap (Priorities 1-3)
✅ Well-known concurrency algorithms explained
✅ Implementation examples

### What Needs Enhancement
1. **Code Examples Accuracy** - Some code examples should match actual implementation
2. **Critical Path Documentation** - Need to document the hot path vs cold path
3. **Performance Characteristics** - More specific numbers for each operation
4. **Implementation Guidance** - Step-by-step for users needing thread-safety

## Implementation Plan

### Phase 1: Critical Issues Deep Dive (CRITICAL Priority)

Enhance the "Critical Issues" section with:

1. **Free-List Race Condition** (AbstractTable.java:116-117)
   - Actual code from AbstractTable
   - Impact: Data corruption with concurrent saves
   - Workaround: External synchronization required

2. **Tombstone BitSet Not Thread-Safe** (AbstractTable.java:175-186)
   - BitSet operations are not synchronized
   - Impact: Double-decrement of liveRowCount
   - Workaround: Single-writer or external sync

3. **Column Writes Not Atomic** (PageColumn*.java:79-84)
   - Two-step write without coordination
   - Impact: Torn reads possible
   - Workaround: SeqLock (documented but not implemented)

4. **SeqLock Gap** (GeneratedTable.java:51-53, 119-124)
   - Interface documents seqlock but no implementation exists
   - Impact: Design gap
   - Recommendation: Implement or document as future work

### Phase 2: Hot Path Documentation (HIGH Priority)

Document the hot path operations that ARE thread-safe:

1. **Query Execution Path** (HeapRuntimeKernel.java)
   - Zero-reflection dispatch
   - TypeCode switch (O(1))
   - Volatile published watermark for visibility

2. **Index Lookups** (HashIndex.java, RangeIndex.java)
   - Lock-free reads via ConcurrentHashMap
   - Thread-safe updates via compute()

3. **ID Index Lookups** (LongIdIndex.java, StringIdIndex.java)
   - Lock-free reads
   - Thread-safe put/remove

### Phase 3: Performance Impact Matrix

Create detailed performance table:

| Operation | Thread-Safe | Latency | Throughput | Notes |
|-----------|-------------|---------|------------|-------|
| ID generation | YES | ~5ns | 200M ops/s | AtomicLong per entity |
| Query scan | YES | O(n) | 50M rows/s | Volatile published |
| HashIndex lookup | YES | O(1) | 100M ops/s | Lock-free |
| RangeIndex lookup | YES | O(log n) | 20M ops/s | Lock-free |
| Entity save | NO | N/A | External sync required | Free-list race |
| Entity delete | NO | N/A | External sync required | Tombstone race |

### Phase 4: Implementation Guidelines

Add practical guidelines section:

1. **For Single-Threaded Applications**
   - No changes needed
   - Full performance available

2. **For Multi-Threaded Read-Only Applications**
   - Thread-safe out of the box
   - Scales linearly with CPU cores

3. **For Multi-Threaded Read-Write Applications**
   - Option A: External synchronization
   - Option B: Single writer thread
   - Option C: Arena partitioning

## Files to Modify

1. **docs/CONCURRENCY.md** - Main documentation file
   - Enhanced Critical Issues section
   - Hot Path Performance section
   - Implementation Guidelines section
   - Updated code examples matching actual source

## Verification Steps

1. Review all code examples against actual source files
2. Verify performance claims with benchmarks
3. Test workarounds in multi-threaded scenarios
4. Ensure alignment with "zero reflection" principles

## Success Criteria

- All 4 critical issues documented with actual code
- Hot path operations clearly identified as thread-safe
- Performance characteristics quantified
- Practical workarounds provided
- Documentation matches actual implementation
