# Memris Roadmap: Next 6 Months
**Generated:** 2026-02-02
**Focus:** Eventual Consistency, Production Readiness, Performance

---

## Executive Summary

Based on comprehensive review of 5 major system areas, Memris is **production-ready for read-heavy workloads** with a sophisticated heap-based columnar storage engine. The architecture demonstrates excellent design with zero-reflection hot paths, lock-free concurrency, and comprehensive test coverage (64 test classes, 657 methods).

**Critical Gaps Identified:**
- No CI/CD pipeline (manual verification only)
- No code coverage metrics
- Missing close() resource cleanup
- Eventual consistency (no transactions)
- Index-row atomicity gaps
- String pattern matching performance bottleneck

**Roadmap Philosophy:**
1. **Production Hardening First** - Infrastructure, CI/CD, monitoring
2. **Eventual Consistency Acceptable** - No transactions planned (aligns with user request)
3. **Incremental Performance** - 2-4x improvements via targeted optimizations
4. **Developer Experience** - Better APIs, documentation, Spring integration

---

## Current State Assessment

### Strengths âœ…
- **Zero Reflection Hot Paths:** ~1ns overhead for generated bytecode
- **Lock-Free Concurrency:** Multi-reader/multi-writer with SeqLock coordination
- **Comprehensive Testing:** 1.75 test-to-source ratio, 8 concurrency test classes
- **Excellent Documentation:** 7 major documents, 2,000+ lines
- **Superior Code Quality:** Checkstyle, PMD, SpotBugs, Error Prone, Modernizer
- **Rich Query Operators:** Spring Data JPA compatible patterns
- **Arena-Based Isolation:** Multi-tenant and test-friendly

### Production Readiness Gaps âš ï¸
- **No CI/CD:** Manual verification required
- **No Coverage Metrics:** Unknown test coverage percentage
- **Resource Cleanup TODO:** Potential memory leaks
- **Eventual Index Consistency:** Index-row update not atomic
- **No Monitoring:** No metrics for contention, seqlock retries, free-list health
- **Limited Error Handling:** Generic MemrisException only
- **Manual Cascade Operations:** No automatic cascade delete/orphan removal

### Performance Bottlenecks ðŸ”»
- **String Pattern Matching:** O(n) full scan (LIKE, CONTAINING, STARTING_WITH)
- **BigDecimal/BigInteger:** Equality only (no GT, GTE, LT, LTE, BETWEEN)
- **Many-to-Many Joins:** Not fully optimized
- **SeqLock Contention:** Degrades under >16 concurrent writers
- **RowIdSet Copy-on-Write:** Overhead on popular index keys
- **No SIMD Vectorization:** Relies on JIT auto-vectorization only

---

## 6-Month Roadmap

### Month 1-2: Production Hardening (P0)

**Objective:** Establish CI/CD, monitoring, and safety nets

#### 1.1 CI/CD Pipeline (Week 1-2)
```yaml
# .github/workflows/ci.yml
- Build on push/PR
- Run full test suite (mvn verify)
- Code quality checks (checkstyle, PMD, SpotBugs)
- Coverage reporting (Codecov)
- Performance regression detection
```
**Impact:** Prevents broken builds, automated safety net
**Effort:** 1 week
**Priority:** P0

#### 1.2 Code Coverage Metrics (Week 2-3)
- Integrate JaCoCo with Codecov
- Target: 85%+ line coverage
- Per-component coverage dashboard
**Impact:** Visibility into test coverage, quality gates
**Effort:** 1 week
**Priority:** P0

#### 1.3 Resource Cleanup (Week 3)
**File:** `MemrisRepositoryFactory.java:246`
```java
@Override
public void close() {
    // Clear all arenas
    arenas.values().forEach(MemrisArena::close);
    arenas.clear();

    // Shutdown thread pools (if any)
    // Release ByteBuddy caches
    // Clear generated classes
}
```
**Impact:** Prevents memory leaks, proper shutdown
**Effort:** 3 days
**Priority:** P0

#### 1.4 Monitoring & Metrics (Week 4)
**New Package:** `io.memris.metrics`
```java
public final class MemrisMetrics {
    // SeqLock metrics
    public static final Counter seqLockRetries;
    public static final Timer seqLockWaitTime;

    // Index metrics
    public static final Counter indexUpdates;
    public static final Counter indexStaleLookups;

    // Free-list metrics
    public static final Gauge freeListSize;

    // Query metrics
    public static final Counter tableScanCount;
    public static final Counter indexLookupCount;
}
```
**Impact:** Production observability, performance tuning
**Effort:** 1 week
**Priority:** P0

#### 1.5 CONTRIBUTING.md (Week 4)
```markdown
# Contributing to Memris

## Development Setup
## Code of Conduct
## Pull Request Process
## Commit Message Conventions
## Running Tests
## Code Style
```
**Impact:** Lower barrier to contributors
**Effort:** 2 days
**Priority:** P1

---

### Month 2-3: Performance Optimizations (P1)

**Objective:** Address critical bottlenecks with 2-4x improvements

#### 2.1 String Pattern Matching Optimization (Week 5-7)
**File:** `StringTypeHandler.java`, `PageColumnString.java`

**Strategy A: Prefix Tree for STARTING_WITH**
```java
// New class: StringPrefixTreeIndex
public final class StringPrefixTreeIndex {
    private final TrieNode root;

    public RowIdSet startsWith(String prefix) {
        TrieNode node = traverse(root, prefix);
        return collectAllDescendants(node);  // O(k) where k = matches
    }
}
```

**Strategy B: Reverse String Index for ENDING_WITH**
```java
// New class: StringSuffixIndex
public final class StringSuffixIndex {
    private final HashIndex<String> reversedIndex;

    public RowIdSet endsWith(String suffix) {
        String reversed = new StringBuilder(suffix).reverse().toString();
        return reversedIndex.lookup(reversed);
    }
}
```

**Strategy C: Bloom Filter Pre-Check for Negative Cases**
```java
public int[] scanContains(String target, int limit) {
    // Fast negative check
    if (!bloomFilter.mightContain(target)) {
        return EMPTY;  // O(1) negative case
    }
    // Fallback to full scan
    return fullScanContains(target, limit);
}
```
**Impact:** 10-100x improvement for pattern queries on large tables
**Effort:** 3 weeks
**Priority:** P1

#### 2.2 BigDecimal/BigInteger Operators (Week 7-8)
**File:** `BigDecimalTypeHandler.java`, `BigIntegerTypeHandler.java`

**Add Comparison Operators:**
```java
// BigDecimalTypeHandler.java
@Override
public boolean compare(BigDecimal a, BigDecimal b, Operator op) {
    int cmp = a.compareTo(b);
    return switch (op) {
        case GT -> cmp > 0;
        case GTE -> cmp >= 0;
        case LT -> cmp < 0;
        case LTE -> cmp <= 0;
        case BETWEEN -> cmp >= 0 && a.compareTo((BigDecimal) arg2) <= 0;
        default -> throw new UnsupportedOperatorException();
    };
}
```
**Impact:** Full query operator coverage for decimal types
**Effort:** 1 week
**Priority:** P1

#### 2.3 Striped Index Updates (Week 8-9)
**File:** `HashIndex.java`, `RangeIndex.java`

**Strategy: Partition indexes by key hash**
```java
public final class StripedHashIndex<K> {
    private final ConcurrentHashMap<K, MutableRowIdSet>[] stripes;
    private final int stripeCount = 16;

    public void add(K key, RowId rowId) {
        int stripe = Math.abs(hash(key)) % stripeCount;
        stripes[stripe].compute(key, (ignored, existing) -> {
            // Same logic as HashIndex, but striped
        });
    }
}
```
**Impact:** 4-8x throughput for high-concurrency inserts on popular keys
**Effort:** 1 week
**Priority:** P1

#### 2.4 Many-to-Many Join Optimization (Week 9)
**File:** `JoinExecutorImpl.java`

**Strategy: Hash join with pre-built join table indexes**
```java
// New class: ManyToManyJoinExecutor
public final class ManyToManyJoinExecutor<T, U> {
    private final GeneratedTable<T> leftTable;
    private final GeneratedTable<U> rightTable;
    private final GeneratedTable<?> joinTable;  // Generated at table creation time

    public Selection execute(Selection leftSelection) {
        // Hash join via join table
        // Pre-built indexes on joinTable.leftId and joinTable.rightId
    }
}
```
**Impact:** 2-5x throughput for @ManyToMany queries
**Effort:** 2 weeks
**Priority:** P1

---

### Month 3-4: API Improvements & Spring Integration (P2)

**Objective:** Better developer experience, Spring DI integration

#### 3.1 Pagination Support (Week 10-11)
**New Interface:** `Pageable`, `Page<T>`, `Slice<T>`
```java
public interface Pageable {
    int getPageNumber();
    int getPageSize();
    Sort getSort();
}

public interface Page<T> extends Slice<T> {
    int getTotalPages();
    long getTotalElements();
    boolean hasNext();
    boolean hasPrevious();
}

// Repository methods
List<Customer> findByStatus(String status, Pageable pageable);
Page<Order> findByCustomerId(Long customerId, Pageable pageable);
```
**File:** `io.memris.repository.Pageable`, `io.memris.repository.Page`
**Impact:** Full Spring Data pagination compatibility
**Effort:** 2 weeks
**Priority:** P2

#### 3.2 Spring Boot Starter (Week 11-12)
**New Module:** `memris-spring-boot-starter`
```java
@Configuration
@EnableMemrisRepositories
public class MemrisAutoConfiguration {

    @Bean
    public MemrisRepositoryFactory memrisFactory(MemrisProperties properties) {
        return new MemrisRepositoryFactory(properties.toConfiguration());
    }

    @Bean
    public MemrisRepositoryFactoryBean<?> memrisRepositoryFactoryBean() {
        return new MemrisRepositoryFactoryBean<>();
    }
}
```
**File:** `memris-spring-boot-starter/src/main/java/.../MemrisAutoConfiguration.java`
**Impact:** Spring DI integration, zero-config setup
**Effort:** 2 weeks
**Priority:** P2

#### 3.3 Lifecycle Callbacks (Week 12-13)
**New Annotations:** `@PrePersist`, `@PreUpdate`, `@PreRemove`, `@PostUpdate`, `@PostRemove`
```java
@Entity
public class Customer {
    @PrePersist
    public void onCreate() {
        this.created = System.currentTimeMillis();
        this.version = 0;
    }

    @PreUpdate
    public void onUpdate() {
        this.updated = System.currentTimeMillis();
        this.version++;
    }
}
```
**File:** `io.memris.core.PrePersist`, etc.
**Impact:** Automatic audit field population, lifecycle hooks
**Effort:** 1 week
**Priority:** P2

#### 3.4 Cascade Operations (Week 13-14)
**New Enum:** `CascadeType` with ALL, PERSIST, MERGE, REMOVE, REFRESH
```java
@Entity
public class Order {
    @OneToMany(mappedBy = "order", cascade = CascadeType.ALL, orphanRemoval = true)
    public List<OrderItem> items;
}

// When deleting order:
orderRepo.delete(order);  // Automatically deletes all order items
```
**File:** `io.memris.core.CascadeType`
**Impact:** Automatic cascade delete/orphan removal
**Effort:** 1 week
**Priority:** P2

---

### Month 4-5: Advanced Features & Enterprise Readiness (P2)

**Objective:** Enterprise features, query enhancements

#### 4.1 DISTINCT Query Execution (Week 14-15)
**File:** `RepositoryRuntime.java`, `QueryMethodLexer.java`

**Implementation:**
```java
// Tokenization (already done)
// Execution:
public Selection executeDistinct(Selection selection, int[] distinctColumns) {
    // Collect distinct values using HashSet for string columns
    // Sort and deduplicate for primitive columns
    // Return filtered selection
}
```
**Impact:** Complete DISTINCT support (currently tokenized but incomplete)
**Effort:** 1 week
**Priority:** P2

#### 4.2 HAVING Clause Expansion (Week 15)
**File:** `RepositoryRuntime.java:960`

**Current:** Only COUNT groupings
**Expand to:** All aggregate types (SUM, AVG, MIN, MAX)
```java
// Query method:
Map<String, Long> groupByStatusSumTotal();

// Execution:
public Map<String, Long> executeGroupingWithSum(Selection selection, String groupColumn, String sumColumn) {
    // Group by groupColumn, SUM sumColumn
    // Support HAVING with arithmetic expressions
}
```
**Impact:** Full HAVING clause support
**Effort:** 1 week
**Priority:** P2

#### 4.3 Exception Hierarchy (Week 15-16)
**New Exception Classes:**
```java
public class EntityNotFoundException extends MemrisException {
    public EntityNotFoundException(Class<?> entityClass, Object id) { ... }
}

public class OptimisticLockException extends MemrisException {
    public OptimisticLockException(Class<?> entityClass, Object id, long expectedVersion, long actualVersion) { ... }
}

public class StaleStateException extends MemrisException {
    public StaleStateException(String message) { ... }
}
```
**Impact:** Better error handling, actionable error messages
**Effort:** 1 week
**Priority:** P2

#### 4.4 QueryDSL Support (Week 16)
**New Interface:** `Specification<T>`, `Predicate<T>`
```java
public interface Specification<T> {
    Predicate toPredicate(Root<T> root, CriteriaQuery<?> query, CriteriaBuilder cb);
}

// Usage:
Specification<Customer> spec = (root, query, cb) ->
    cb.and(cb.equal(root.get("status"), "ACTIVE"),
           cb.greaterThan(root.get("created"), System.currentTimeMillis() - 86400000));

List<Customer> customers = customerRepo.findAll(spec);
```
**Impact:** Type-safe query builder, complex queries without @Query
**Effort:** 2 weeks
**Priority:** P2

---

### Month 5-6: Testing Infrastructure & Documentation (P2)

**Objective:** Better tests, more examples, improved developer experience

#### 5.1 Test Fixture Infrastructure (Week 17-18)
**New Class:** `MemrisTest` (base test class)
```java
public abstract class MemrisTest {
    protected MemrisRepositoryFactory factory;
    protected MemrisArena arena;

    @BeforeEach
    void setUp() {
        factory = new MemrisRepositoryFactory();
        arena = factory.createArena();
    }

    @AfterEach
    void tearDown() throws Exception {
        arena.close();
        factory.close();
    }
}

// Test data builders
public class CustomerBuilder {
    private String email = "test@example.com";
    private String name = "Test User";
    private String phone = "555-0000";

    public CustomerBuilder email(String email) { this.email = email; return this; }
    public CustomerBuilder name(String name) { this.name = name; return this; }
    public CustomerBuilder phone(String phone) { this.phone = phone; return this; }
    public Customer build() { return new Customer(email, name, phone); }
}
```
**Impact:** Reduced test setup duplication, better test organization
**Effort:** 1 week
**Priority:** P2

#### 5.2 Parameterized Tests (Week 18)
**Refactor existing tests to use JUnit 5 @ParameterizedTest**
```java
@ParameterizedTest
@CsvSource({
    "EQ, 100, true",
    "GT, 99, true",
    "GT, 100, false",
    "LT, 101, true"
})
void numericOperatorTests(String operatorName, int value, boolean expected) {
    // Test all numeric operators with parameters
}
```
**Impact:** Reduced test code duplication, better coverage
**Effort:** 1 week
**Priority:** P2

#### 5.3 Performance Regression Tests (Week 19)
**Enhance JMH benchmarks with @Threshold**
```java
@Benchmark
@Threshold(value = 0.01, unit = TimeUnit.MILLISECONDS)  // Fail if >10Î¼s
public long lookupById(long id) {
    return idIndex.lookupById(id);
}

// CI integration:
// mvn verify -Pjmh-threshold-check
```
**Impact:** Automated performance regression detection
**Effort:** 1 week
**Priority:** P1

#### 5.4 Getting Started Tutorial (Week 19-20)
**New File:** `docs/examples/tutorial-step-by-step.md`
```markdown
# Memris Tutorial: Build a Simple Address Book

## Step 1: Add Dependencies
## Step 2: Define Your First Entity
## Step 3: Create a Repository
## Step 4: Save and Find Data
## Step 5: Add Indexes for Performance
## Step 6: Query with Conditions
## Step 7: Join Multiple Entities
## Step 8: Handle Relationships
## Step 9: Use Pagination
## Step 10: Performance Tuning
```
**Impact:** Lower learning curve for new users
**Effort:** 1 week
**Priority:** P2

#### 5.5 Multi-Scenario Examples (Week 20)
**New Examples:**
- Spring Boot integration example
- Multi-tenant application example
- Migration from JPA/Hibernate guide
- Advanced JPQL patterns reference
- Performance tuning guide (JVM settings, configuration)
**Impact:** Real-world examples for common use cases
**Effort:** 2 weeks
**Priority:** P2

#### 5.6 Stress Tests (Week 21)
**New Test Class:** `LargeDatasetStressTest`
```java
@Test
@Timeout(value = 5, unit = TimeUnit.MINUTES)
void stressTest_10M_rows_insert_and_query() {
    // Insert 10M rows
    // Measure memory usage
    // Verify query performance
}

@Test
void stressTest_memory_pressure() {
    // Allocate 80% heap
    // Verify GC behavior
    // Measure throughput degradation
}
```
**Impact:** Scalability validation, memory behavior understanding
**Effort:** 1 week
**Priority:** P2

---

## Post-6-Month Considerations (Beyond Scope)

These items are **deferred** based on the roadmap prioritization:

### Deferred: Phase 3 - Advanced Concurrency
**Reason:** User explicitly requested "eventual consistency only, no transactions"

- Snapshot Isolation (MVCC) - âŒ Deferred
- Transaction Support - âŒ Deferred (explicitly out of scope)

### Deferred: Phase 5 - Storage Evolution
**Reason:** Low priority, significant implementation complexity

- FFM Off-Heap Storage - âŒ Deferred (LOW priority, requires `--enable-native-access`)
- SIMD Vectorization - âŒ Deferred (LOW priority, JIT auto-vectorization sufficient for most workloads)

### Deferred: Phase 6 - Enterprise Features
**Reason:** Long-term enterprise features not needed for next 6 months

- Schema Evolution - âŒ Deferred (LOW priority)
- Distributed Storage - âŒ Deferred (LOW priority)

---

## Success Metrics

### Month 2 Milestones
- âœ… CI/CD pipeline running on all PRs
- âœ… Code coverage dashboard (target: 85%+)
- âœ… Resource cleanup implemented (no memory leaks)
- âœ… Monitoring metrics exposed (seqlock retries, index health)
- âœ… CONTRIBUTING.md published

### Month 4 Milestones
- âœ… String pattern matching: 10-100x improvement on large tables
- âœ… BigDecimal/BigInteger: Full operator support
- âœ… Striped index updates: 4-8x throughput for high-concurrency inserts
- âœ… Many-to-many joins: 2-5x throughput improvement
- âœ… Pagination: Full Spring Data compatibility
- âœ… Spring Boot starter: Zero-config setup
- âœ… Lifecycle callbacks: @PrePersist, @PreUpdate, @PreRemove, etc.
- âœ… Cascade operations: CascadeType.ALL with orphanRemoval

### Month 6 Milestones
- âœ… DISTINCT queries: Full execution support
- âœ… HAVING clause: All aggregate types supported
- âœ… Exception hierarchy: Actionable error messages
- âœ… QueryDSL: Type-safe query builder
- âœ… Test infrastructure: Fixtures, parameterized tests, performance regression tests
- âœ… Documentation: Tutorial, multi-scenario examples, migration guides
- âœ… Stress tests: Scalability validation (10M+ rows)

### Performance Targets
- Insert throughput: >200k ops/sec (current: ~146k)
- ID lookup: >500k ops/sec (current: ~413k)
- String pattern matching: <10ms for 1M rows (current: ~100ms)
- Concurrency: >32 concurrent writers (current: degrades after 16)
- Scan performance: 2-4x improvement with SIMD (deferred)

---

## Risk Assessment

### High Risk Items
1. **String Prefix Tree Implementation:** Complex data structure, memory overhead
   - **Mitigation:** Start with simple HashMap-based approach, benchmark before/after

2. **Spring Boot Starter:** Significant complexity in DI integration
   - **Mitigation:** Follow Spring Data patterns closely, extensive testing

3. **Cascade Operations:** Potential for accidental data loss
   - **Mitigation:** Default to no cascade, explicit opt-in, extensive documentation

### Medium Risk Items
1. **Striped Index Updates:** May cause cache locality issues
   - **Mitigation:** Benchmark stripe count (16, 32, 64), monitor GC behavior

2. **Many-to-Many Join Optimization:** Join table generation complexity
   - **Mitigation:** Incremental rollout, keep current implementation as fallback

3. **QueryDSL:** Large API surface, may conflict with existing query methods
   - **Mitigation:** Clear separation, opt-in only via `findAll(Specification<T>)`

### Low Risk Items
1. **CI/CD Pipeline:** Standard patterns, low risk
2. **Pagination:** Well-defined interface, Spring Data compatibility
3. **Lifecycle Callbacks:** Simple annotation processing
4. **Exception Hierarchy:** Non-breaking addition, existing code unaffected
5. **Test Infrastructure:** Refactoring only, no behavior changes

---

## Resource Estimates

### Total Effort: 6 months (1-2 engineers)

**By Priority:**
- P0 (Production Hardening): 5 weeks
- P1 (Performance Optimizations): 7 weeks
- P2 (API Improvements & Testing): 14 weeks

**By Category:**
- Infrastructure (CI/CD, monitoring, testing): 8 weeks
- Performance optimizations: 7 weeks
- API enhancements (pagination, Spring, cascades): 6 weeks
- Documentation & examples: 5 weeks

### Recommended Team Structure
- **Engineer 1:** Performance & Infrastructure (70%)
- **Engineer 2:** API & Documentation (70%)
- **Cross-functional:** Reviews, testing, documentation (30% each)

---

## Implementation Notes

### Incremental Delivery Strategy
1. **Week-by-week PRs:** No large refactors, small incremental changes
2. **Feature flags:** New features behind opt-in flags where appropriate
3. **Backward compatibility:** No breaking changes to existing APIs
4. **Deprecation warnings:** Mark deprecated features before removal

### Testing Strategy
1. **All PRs:** CI/CD pipeline must pass
2. **Performance changes:** Before/after benchmarks required
3. **New APIs:** Comprehensive integration tests required
4. **Concurrency changes:** Stress tests with timeout protection

### Documentation Strategy
1. **Code changes:** Update inline JavaDoc
2. **New features:** Update relevant docs (QUERY.md, DEVELOPMENT.md, etc.)
3. **Examples:** Add real-world usage examples
4. **Breaking changes:** Migration guide required

---

## Conclusion

This roadmap focuses on **production hardening** (Month 1-2), **performance optimizations** (Month 2-3), **API improvements** (Month 3-4), and **testing/documentation** (Month 5-6). The approach is incremental, with no breaking changes to existing APIs, and all changes are backward compatible.

**Key Philosophy:**
- **Eventual consistency acceptable** - No transactions (aligns with user request)
- **Production readiness first** - CI/CD, monitoring, safety nets
- **Performance improvements** - Targeted 2-100x improvements on bottlenecks
- **Developer experience** - Better APIs, Spring integration, documentation

By the end of Month 6, Memris will have:
- âœ… Automated CI/CD pipeline with coverage metrics
- âœ… Production observability (monitoring, metrics)
- âœ… 2-100x performance improvements on key bottlenecks
- âœ… Full Spring Data pagination compatibility
- âœ… Spring Boot starter for zero-config setup
- âœ… Lifecycle callbacks and cascade operations
- âœ… Comprehensive test infrastructure
- âœ… Rich documentation and examples

This positions Memris as a **production-ready, high-performance in-memory storage engine** with excellent developer experience for read-heavy workloads with eventual consistency.
