# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Build Commands

```bash
# Full clean build
mvn clean compile

# Quick compile (quiet mode)
mvn -X compile

# Run all tests
mvn -X -pl memris-core test

# Run single test class
mvn -X -pl memris-core test -Dtest=ClassName

# Run single test method
mvn -X -pl memris-core test -Dtest=ClassName#methodName

# Run benchmarks (requires manual java invocation with preview flags)
# Throughput benchmark
java --enable-preview --add-modules jdk.incubator.vector -cp memris-core/target/classes io.memris.benchmarks.BenchmarkRunner

# JMH microbenchmarks (latency-focused)
mvn clean compile
java --enable-preview --add-modules jdk.incubator.vector -cp memris-core/target/classes:jmh-benchmarks.jar io.memris.benchmarks.MemrisBenchmarks
```

### Java Runtime Requirements
- **Java Version**: 21 (required)
- **Preview Features**: `--enable-preview`
- **Modules**: `jdk.incubator.vector` (SIMD), `java.base` (FFM)
- **Native Access**: `--enable-native-access=ALL-UNNAMED`

## Project Overview

**Memris** is a blazingly fast, multi-threaded, in-memory storage engine for Java 21 with:
- SIMD vectorized execution using Panama Vector API
- FFM (Foreign Function & Memory) MemorySegment-based storage
- Spring Data JPA repository integration via ByteBuddy dynamic bytecode generation
- O(1) design principle: no O(n) operations allowed in hot paths

### High-Level Architecture

```
MemrisRepositoryFactory
  - Creates repositories via ByteBuddy bytecode generation
  - Manages FfmTable instances per entity class
  - Manages join tables for relationships
  - Arena lifecycle management (Arena.ofConfined())
         |
    FfmTable (Columnar storage with SIMD scans)
         |
    FfmIntColumn, FfmLongColumn, FfmStringColumn, etc.
```

### Key Components

**Storage Layer** (`io.memris.storage.ffm`):
- `FfmTable` - Main table with type-specific column storage
- `FfmIntColumn`, `FfmLongColumn`, etc. - Primitive columns with SIMD vector scans
- `FfmStringColumn` - Variable-length string storage with StringPool

**Spring Data Integration** (`io.memris.spring`):
- `MemrisRepositoryFactory` - Entry point for creating repositories
- `RepositoryBytecodeGenerator` - Uses ByteBuddy Advice API to generate repository implementations
- `QueryMethodParser` - Parses Spring Data JPA query method names (findByXxx, countByXxx)
- `EntityMetadata` - Extracts entity structure via reflection
- `TypeConverterRegistry` - Extensible type conversion

**Selection Pipeline** (`io.memris.kernel.selection`):
- `SelectionVector` - Row selection result interface
- `IntSelection` - Sparse (<4K rows), `BitsetSelection` - Dense (>=4K rows)

**Query Execution** (`io.memris.kernel`):
- `Predicate` - Filter conditions (Comparison, In, Between)
- `PlanNode` - Query plan operators (Scan, Filter, Join, Sort, Limit)

## Critical Design Principles

### 1. O(1) First, O(log n) Second, O(n) Forbidden
All hot path operations must be O(1).

### 2. Primitive-Only APIs
Never use boxed types in hot paths. Use `IntEnumerator`/`LongEnumerator` instead of `Iterator<Integer>`.

### 3. Java 21 Type Switches (CRITICAL)
Always use pattern matching switch with class literals for type dispatch:
```java
FfmColumn<?> column = switch (type) {
    case int.class, Integer.class -> new FfmIntColumn(...);
    case long.class, Long.class -> new FfmLongColumn(...);
    case String.class -> new FfmStringColumnImpl(...);
    default -> throw new IllegalArgumentException("Unsupported type: " + type);
};
```

### 4. ByteBuddy Bytecode Generation
Repository implementations are generated at runtime:
- Only methods declared in the interface are generated
- MethodHandles pre-compiled for field access (zero overhead)
- No reflection in generated bytecode

### 5. Join Table Limitation
**CRITICAL**: Join tables (@OneToMany, @ManyToMany) currently only support numeric ID types (int, long). UUID/String ID entities cannot use join table relationships.

## Important Files

| File | Purpose |
|------|---------|
| `MemrisRepositoryFactory.java` | Main factory, manages tables and repositories |
| `RepositoryBytecodeGenerator.java` | ByteBuddy-based repository generation |
| `QueryMethodParser.java` | JPA query method parsing |
| `FfmTable.java` | Columnar storage with SIMD scans |
| `AGENTS.md` | Detailed development guidelines |
| `SPRING_DATA_ROADMAP.md` | Spring Data feature roadmap |
